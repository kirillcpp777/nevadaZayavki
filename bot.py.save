import asyncio
import logging
import re
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# ============================================
# –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø - –ó–ê–ü–û–í–ù–ò –¶–Ü –î–ê–ù–Ü
# ============================================

# –¢–æ–∫–µ–Ω —Ç–≤–æ–≥–æ Telegram-–±–æ—Ç–∞ (–æ—Ç—Ä–∏–º–∞–π —É @BotFather)
TELEGRAM_TOKEN = "–¢–í–Ü–ô_–¢–û–ö–ï–ù_–°–Æ–î–ò"

# ID —Ç–≤–æ—î—ó Google Sheets —Ç–∞–±–ª–∏—Ü—ñ (–∑ URL —Ç–∞–±–ª–∏—Ü—ñ)
SPREADSHEET_ID = "–¢–í–Ü–ô_ID_–¢–ê–ë–õ–ò–¶–Ü_–°–Æ–î–ò"

# –®–ª—è—Ö –¥–æ JSON-—Ñ–∞–π–ª—É –∑ –∫–ª—é—á–∞–º–∏ Service Account
SERVICE_ACCOUNT_FILE = "—Ç–≤—ñ–π-—Ñ–∞–π–ª-–∫–ª—é—á—ñ–≤.json"

# ============================================
# –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ó–ê–í–ï–†–®–ï–ù–û
# ============================================

# –õ–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(level=logging.INFO)

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–æ—Ç–∞
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

# –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Google Sheets
def get_sheets_client():
    scope = [
        "https://spreadsheets.google.com/feeds",
        "https://www.googleapis.com/auth/drive"
    ]
    creds = ServiceAccountCredentials.from_json_keyfile_name(SERVICE_ACCOUNT_FILE, scope)
    client = gspread.authorize(creds)
    return client

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
def get_spreadsheet():
    client = get_sheets_client()
    return client.open_by_key(SPREADSHEET_ID)

# –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
def parse_message(text):
    words = text.split()
    
    number = None
    username = None
    tiktok_links = []
    
    for word in words:
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ TikTok –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        if "https://" in word and "tiktok.com" in word:
            tiktok_links.append(word)
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —á–∏—Å–ª–æ
        elif word.isdigit():
            if number is None:  # –ë–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à–µ —á–∏—Å–ª–æ
                number = int(word)
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ username (–Ω–µ —á–∏—Å–ª–æ, –Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è)
        elif "https://" not in word and not word.isdigit():
            if username is None:  # –ë–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à–∏–π username
                username = word
    
    return username, number, tiktok_links

# –ó–∞–ø–∏—Å —É TEAM
def write_to_team(username, number, links):
    sheet = get_spreadsheet()
    team_sheet = sheet.worksheet("TEAM")
    
    links_str = " | ".join(links)
    team_sheet.append_row([username, number, links_str])

# –ó–∞–ø–∏—Å —É OFFERS
def write_to_offers(number, links):
    sheet = get_spreadsheet()
    offers_sheet = sheet.worksheet("OFFERS")
    
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    links_str = " | ".join(links)
    offers_sheet.append_row([now, number, links_str])

# –û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏ /start
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer(
        "üëã –ü—Ä–∏–≤—ñ—Ç! –Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å—É TikTok-–ø–æ—Å–∏–ª–∞–Ω—å.\n\n"
        "üìù –ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑:\n"
        "‚Ä¢ Username (–¥–ª—è TEAM)\n"
        "‚Ä¢ –ù–æ–º–µ—Ä\n"
        "‚Ä¢ TikTok-–ø–æ—Å–∏–ª–∞–Ω–Ω—è\n\n"
        "–ü—Ä–∏–∫–ª–∞–¥–∏:\n"
        "üîπ roma 1 https://tiktok.com/@roma\n"
        "üîπ 2 https://tiktok.com/@user (–±–µ–∑ username)"
    )

# –û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
@dp.message()
async def handle_message(message: types.Message):
    text = message.text
    username, number, tiktok_links = parse_message(text)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏—Ö –≤–∏–º–æ–≥
    if number is None or len(tiktok_links) == 0:
        await message.answer("‚ùå –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∏–º–æ–≥–∞–º.\n\n–ü–æ—Ç—Ä—ñ–±–Ω–æ: –Ω–æ–º–µ—Ä + —Ö–æ—á–∞ –± –æ–¥–Ω–µ TikTok-–ø–æ—Å–∏–ª–∞–Ω–Ω—è")
        return
    
    try:
        # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É –∑–∞–ø–∏—Å—É
        if username:
            # –ó–∞–ø–∏—Å —É TEAM
            write_to_team(username, number, tiktok_links)
            record_type = "TEAM"
        else:
            # –ó–∞–ø–∏—Å —É OFFERS
            write_to_offers(number, tiktok_links)
            record_type = "OFFERS"
        
        # –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
        await message.answer(
            f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ\n\n"
            f"üìã –¢–∏–ø: {record_type}\n"
            f"üî¢ –ù–æ–º–µ—Ä: {number}\n"
            f"üîó –ü–æ—Å–∏–ª–∞–Ω—å: {len(tiktok_links)}"
        )
        
    except Exception as e:
        logging.error(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É: {e}")
        await message.answer(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å—ñ –≤ —Ç–∞–±–ª–∏—Ü—é.\n\n–î–µ—Ç–∞–ª—ñ: {str(e)}")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
